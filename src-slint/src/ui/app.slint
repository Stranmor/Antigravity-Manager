// Antigravity Manager - Main Application Window

import { VerticalBox, HorizontalBox, ScrollView, LineEdit, ComboBox, Switch } from "std-widgets.slint";
import { Dashboard } from "dashboard.slint";
import { AccountsPage, AccountData, FilterType, ViewMode } from "accounts.slint";
import { SettingsPage, SettingsData } from "settings.slint";
import { ApiProxyPage, ProxyStatus, ProxyConfig } from "proxy.slint";
import { MonitorPage, RequestLog, MonitorStats } from "monitor.slint";
import { Sidebar } from "components/sidebar.slint";
import { Theme } from "components/theme.slint";
import { AppState } from "globals.slint";

export struct DashboardStats {
    total_accounts: int,
    avg_gemini: int,
    avg_gemini_image: int,
    avg_claude: int,
    low_quota_count: int,
}

export struct CurrentAccountInfo {
    email: string,
    name: string,
    last_used: string,
    has_account: bool,
}

export component AppWindow inherits Window {
    title: "Antigravity Manager";
    min-width: 1100px;
    min-height: 700px;
    background: Theme.background;
    
    // Dashboard stats
    in-out property <DashboardStats> stats: {
        total_accounts: 0,
        avg_gemini: 0,
        avg_gemini_image: 0,
        avg_claude: 0,
        low_quota_count: 0,
    };
    
    in-out property <CurrentAccountInfo> current_account: {
        email: "",
        name: "",
        last_used: "",
        has_account: false,
    };
    
    // Page: 0=Dashboard, 1=Accounts, 2=Proxy, 3=Settings, 4=Monitor
    in-out property <int> current-page: 0;
    
    // Dashboard callbacks
    callback navigate(int);
    callback refresh-accounts();
    callback add-account();
    callback switch-account();
    
    navigate(page) => { current-page = page; }
    
    HorizontalBox {
        padding: 0px;
        spacing: 0px;
        
        Sidebar {
            width: 220px;
            current-page: root.current-page;
            navigate(page) => { root.navigate(page); }
        }
        
        Rectangle {
            background: Theme.background;
            
            // Dashboard
            if current-page == 0: Dashboard {
                width: 100%;
                height: 100%;
                stats: root.stats;
                current-account: root.current_account;
                refresh-accounts => { root.refresh-accounts(); }
                add-account => { root.add-account(); }
                switch-account => { root.switch-account(); }
            }
            
            // Accounts
            if current-page == 1: AccountsPage {
                width: 100%;
                height: 100%;
                accounts: AppState.accounts;
                selected-count: AppState.selected-count;
                is-refreshing: AppState.is-refreshing;
                current-page: AppState.current-page;
                total-pages: AppState.total-pages;
                total-items: AppState.total-items;
                all-count: AppState.all-count;
                pro-count: AppState.pro-count;
                ultra-count: AppState.ultra-count;
                free-count: AppState.free-count;
                
                add-account => { AppState.add-account(); }
                refresh-all => { AppState.refresh-all(); }
                export-selected => { AppState.export-selected(); }
                delete-selected => { AppState.delete-selected(); }
                toggle-proxy-batch(e) => { AppState.toggle-proxy-batch(e); }
                search-changed(q) => { AppState.search-changed(q); }
                toggle-select(id) => { AppState.toggle-select(id); }
                toggle-all => { AppState.toggle-all(); }
                switch-account(id) => { AppState.switch-account(id); }
                refresh-account(id) => { AppState.refresh-account(id); }
                view-details(id) => { AppState.view-details(id); }
                export-account(id) => { AppState.export-account(id); }
                delete-account(id) => { AppState.delete-account(id); }
                toggle-proxy(id) => { AppState.toggle-proxy(id); }
            }
            
            // Proxy
            if current-page == 2: ApiProxyPage {
                width: 100%;
                height: 100%;
                // TODO: Bind status and config from AppState
            }
            
            // Settings
            if current-page == 3: SettingsPage {
                width: 100%;
                height: 100%;
            }
            
            // Monitor
            if current-page == 4: MonitorPage {
                width: 100%;
                height: 100%;
                back => { root.navigate(2); }  // Go back to Proxy page
            }
        }
    }
}

export { AccountData, FilterType, ViewMode, AppState }

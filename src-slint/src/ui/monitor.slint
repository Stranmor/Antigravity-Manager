// Monitor Page - Real-time Request Monitor

import { VerticalBox, HorizontalBox, ScrollView, LineEdit, Button } from "std-widgets.slint";
import { Theme } from "components/theme.slint";

// Request log entry
export struct RequestLog {
    id: string,
    timestamp: int,
    method: string,
    url: string,
    status: int,
    duration: int,
    model: string,
    mapped_model: string,
    account_email: string,
    input_tokens: int,
    output_tokens: int,
    error: string,
}

// Monitor stats
export struct MonitorStats {
    total_requests: int,
    success_count: int,
    error_count: int,
}

// Quick filter button
component FilterButton inherits Rectangle {
    in property <string> label;
    in property <bool> active: false;
    
    callback clicked();
    
    width: label.character-count * 8px + 20px;
    height: 26px;
    background: active ? Theme.accent-blue : Theme.surface-elevated;
    border-radius: 13px;
    border-width: 1px;
    border-color: active ? Theme.accent-blue : Theme.border;
    
    Text {
        text: label;
        color: active ? white : Theme.text-secondary;
        font-size: 11px;
        font-weight: 500;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
    
    TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
}

// Log row component
component LogRow inherits Rectangle {
    in property <RequestLog> log;
    
    callback clicked();
    
    height: 40px;
    background: touch.has-hover ? Theme.surface-hover : transparent;
    
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
    
    HorizontalLayout {
        padding-left: 16px;
        padding-right: 16px;
        spacing: 16px;
        
        // Status badge
        Rectangle {
            width: 48px;
            height: 24px;
            background: log.status >= 200 && log.status < 400 ? Theme.success.transparentize(0.85) : Theme.error.transparentize(0.85);
            border-radius: 4px;
            
            Text {
                text: log.status;
                color: log.status >= 200 && log.status < 400 ? Theme.success : Theme.error;
                font-size: 11px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
        
        // Method
        Text {
            width: 50px;
            text: log.method;
            color: Theme.text-primary;
            font-size: 12px;
            font-weight: 700;
            vertical-alignment: center;
        }
        
        // Model with mapping
        Text {
            width: 180px;
            text: log.mapped-model != "" && log.model != log.mapped-model ? 
                  log.model + " ‚Üí " + log.mapped-model : log.model;
            color: Theme.accent-blue;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // Account
        Text {
            width: 120px;
            text: log.account-email;
            color: Theme.text-muted;
            font-size: 10px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // URL
        Text {
            horizontal-stretch: 1;
            text: log.url;
            color: Theme.text-secondary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // Tokens
        HorizontalLayout {
            width: 80px;
            spacing: 4px;
            
            if log.input-tokens > 0: Text {
                text: "I:" + log.input-tokens;
                color: Theme.accent-blue;
                font-size: 9px;
                vertical-alignment: center;
            }
            
            if log.output-tokens > 0: Text {
                text: "O:" + log.output-tokens;
                color: Theme.success;
                font-size: 9px;
                vertical-alignment: center;
            }
        }
        
        // Duration
        Text {
            width: 60px;
            text: log.duration + "ms";
            color: Theme.text-secondary;
            font-size: 11px;
            horizontal-alignment: right;
            vertical-alignment: center;
        }
    }
}

// Main Monitor page
export component MonitorPage inherits Rectangle {
    in property <[RequestLog]> logs: [];
    in property <MonitorStats> stats: {
        total_requests: 0,
        success_count: 0,
        error_count: 0,
    };
    in property <bool> logging_enabled: true;
    in-out property <string> filter: "";
    
    callback toggle-logging();
    callback clear-logs();
    callback set-filter(string);
    callback view-log-details(string);
    callback back();
    
    background: Theme.background;
    
    VerticalLayout {
        padding: 24px;
        spacing: 16px;
        
        // Header with back button
        HorizontalLayout {
            height: 48px;
            spacing: 16px;
            
            // Back button
            Rectangle {
                width: 40px;
                height: 40px;
                background: Theme.surface;
                border-radius: 8px;
                border-width: 1px;
                border-color: Theme.border;
                
                Text {
                    text: "‚Üê";
                    color: Theme.text-primary;
                    font-size: 18px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
                
                TouchArea {
                    mouse-cursor: pointer;
                    clicked => { root.back(); }
                }
            }
            
            VerticalLayout {
                horizontal-stretch: 1;
                alignment: center;
                
                Text {
                    text: "Request Monitor";
                    color: Theme.text-primary;
                    font-size: 20px;
                    font-weight: 700;
                }
                
                Text {
                    text: "Real-time proxy request logging";
                    color: Theme.text-secondary;
                    font-size: 13px;
                }
            }
            
            // Stats badges
            HorizontalLayout {
                spacing: 12px;
                
                Rectangle {
                    height: 32px;
                    background: Theme.accent-blue.transparentize(0.9);
                    border-radius: 6px;
                    
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 6px;
                        
                        Text {
                            text: stats.total-requests;
                            color: Theme.accent-blue;
                            font-size: 13px;
                            font-weight: 700;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "REQS";
                            color: Theme.accent-blue.transparentize(0.3);
                            font-size: 10px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                    }
                }
                
                Rectangle {
                    height: 32px;
                    background: Theme.success.transparentize(0.9);
                    border-radius: 6px;
                    
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 6px;
                        
                        Text {
                            text: stats.success-count;
                            color: Theme.success;
                            font-size: 13px;
                            font-weight: 700;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "OK";
                            color: Theme.success.transparentize(0.3);
                            font-size: 10px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                    }
                }
                
                Rectangle {
                    height: 32px;
                    background: Theme.error.transparentize(0.9);
                    border-radius: 6px;
                    
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 6px;
                        
                        Text {
                            text: stats.error-count;
                            color: Theme.error;
                            font-size: 13px;
                            font-weight: 700;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "ERR";
                            color: Theme.error.transparentize(0.3);
                            font-size: 10px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
        
        // Controls row
        Rectangle {
            height: 56px;
            background: Theme.surface;
            border-radius: 12px;
            border-width: 1px;
            border-color: Theme.border;
            
            HorizontalLayout {
                padding: 12px;
                spacing: 16px;
                
                // Logging toggle
                Rectangle {
                    width: 120px;
                    height: 32px;
                    background: logging-enabled ? Theme.error : Theme.surface-elevated;
                    border-radius: 6px;
                    border-width: logging-enabled ? 0px : 1px;
                    border-color: Theme.border;
                    
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;
                        
                        Rectangle {
                            width: 8px;
                            height: 8px;
                            background: logging-enabled ? white : Theme.text-muted;
                            border-radius: 4px;
                        }
                        
                        Text {
                            text: logging-enabled ? "Recording" : "Paused";
                            color: logging-enabled ? white : Theme.text-secondary;
                            font-size: 12px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => { root.toggle-logging(); }
                    }
                }
                
                // Search
                Rectangle {
                    horizontal-stretch: 1;
                    height: 32px;
                    background: Theme.surface-elevated;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: Theme.border;
                    
                    HorizontalLayout {
                        padding-left: 12px;
                        padding-right: 12px;
                        spacing: 8px;
                        
                        Text {
                            text: "üîç";
                            font-size: 12px;
                            vertical-alignment: center;
                        }
                        
                        LineEdit {
                            horizontal-stretch: 1;
                            text <=> root.filter;
                            placeholder-text: "Filter by URL, model, status...";
                        }
                    }
                }
                
                // Quick filters
                HorizontalLayout {
                    spacing: 8px;
                    
                    FilterButton {
                        label: "All";
                        active: filter == "";
                        clicked => { root.set-filter(""); }
                    }
                    
                    FilterButton {
                        label: "Errors";
                        active: filter == "40";
                        clicked => { root.set-filter("40"); }
                    }
                    
                    FilterButton {
                        label: "Gemini";
                        active: filter == "gemini";
                        clicked => { root.set-filter("gemini"); }
                    }
                    
                    FilterButton {
                        label: "Claude";
                        active: filter == "claude";
                        clicked => { root.set-filter("claude"); }
                    }
                }
                
                // Clear button
                Rectangle {
                    width: 32px;
                    height: 32px;
                    background: Theme.surface-elevated;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: Theme.border;
                    
                    Text {
                        text: "üóë";
                        font-size: 14px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => { root.clear-logs(); }
                    }
                }
            }
        }
        
        // Logs table
        Rectangle {
            vertical-stretch: 1;
            background: Theme.surface;
            border-radius: 12px;
            border-width: 1px;
            border-color: Theme.border;
            
            VerticalLayout {
                // Table header
                Rectangle {
                    height: 40px;
                    background: Theme.surface-elevated;
                    border-radius: 12px;
                    
                    HorizontalLayout {
                        padding-left: 16px;
                        padding-right: 16px;
                        spacing: 16px;
                        
                        Text {
                            width: 48px;
                            text: "Status";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            width: 50px;
                            text: "Method";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            width: 180px;
                            text: "Model";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            width: 120px;
                            text: "Account";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            horizontal-stretch: 1;
                            text: "Path";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            width: 80px;
                            text: "Tokens";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            width: 60px;
                            text: "Duration";
                            color: Theme.text-muted;
                            font-size: 11px;
                            font-weight: 600;
                            horizontal-alignment: right;
                            vertical-alignment: center;
                        }
                    }
                }
                
                Rectangle { height: 1px; background: Theme.border; }
                
                // Logs list
                if logs.length == 0: Rectangle {
                    vertical-stretch: 1;
                    
                    VerticalLayout {
                        alignment: center;
                        spacing: 8px;
                        
                        Text {
                            text: "üì°";
                            font-size: 48px;
                            horizontal-alignment: center;
                        }
                        
                        Text {
                            text: "No requests yet";
                            color: Theme.text-muted;
                            font-size: 14px;
                            horizontal-alignment: center;
                        }
                        
                        Text {
                            text: "Requests will appear here when the proxy is running";
                            color: Theme.text-muted;
                            font-size: 12px;
                            horizontal-alignment: center;
                        }
                    }
                }
                
                if logs.length > 0: ScrollView {
                    vertical-stretch: 1;
                    
                    VerticalLayout {
                        for log in logs: LogRow {
                            log: log;
                            clicked => { root.view-log-details(log.id); }
                        }
                    }
                }
            }
        }
    }
}
